#!/usr/bin/env node
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("axios"),require("fs"),require("csv-parse"),require("validator"),require("minimist")):"function"==typeof define&&define.amd?define(["axios","fs","csv-parse","validator","minimist"],e):e(t.axios,t.fs,t.parse,t.validator,t.minimist)}(this,function(t,e,n,r,o){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t,e=e&&e.hasOwnProperty("default")?e.default:e,n=n&&n.hasOwnProperty("default")?n.default:n,o=o&&o.hasOwnProperty("default")?o.default:o;var i=function(t){return function(){var e=t.apply(this,arguments);return new Promise(function(t,n){return function r(o,i){try{var s=e[o](i),a=s.value}catch(t){return void n(t)}if(!s.done)return Promise.resolve(a).then(function(t){r("next",t)},function(t){r("throw",t)});t(a)}("next")})}},s=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t};let a=(l=i(function*(e){let n=e.host,r=e.username,o=e.password;const i=e.secure?"https":"http";return(yield t.post(`${i}://${n}/wp-json/jwt-auth/v1/token`,{username:r,password:o},{headers:{"Content-Type":"application/json"}}).catch(function(t){console.error(t),process.exit(1)})).data}),function(t){return l.apply(this,arguments)});var l;let c=(u=i(function*(e){var n=yield e;const r=n.existingData,o=function(t,e){var n={};for(var r in t)e.indexOf(r)>=0||Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r]);return n}(n,["existingData"]),i=this[P].token,s=JSON.stringify(o),a={headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`}},l=r?this[m]+r.id:this[m];yield t.post(l,s,a).catch(function(t){return console.error(l,o.title,"\n",t)})}),function(t){return u.apply(this,arguments)});var u;let f=(p=i(function*(e){const n=`${this[m]}?per_page=50&search=${e.fields.email}`,r=(yield t.get(n)).data.filter(function(t){return"contact_info"===t.type})[0];return s({},e,{existingData:r})}),function(t){return p.apply(this,arguments)});var p;const d=Symbol("Personnel File"),h=Symbol("Valid personnel records"),y=Symbol("WordPress Client"),m=Symbol("Personnel API Route"),v=Symbol("Advanced Custom Field Route"),P=Symbol("JWT for WP API"),g=Symbol("HTTP vs HTTPS");function w(t,e){if("PHONE"===e[1])return t.push([e]),t;const n=t.pop();return n.push(e),t.push(n),t}function j(t){return{office:t[0],personnel:t.slice(1).filter(t=>r.isEmail(t[5]))}}function O(t){const e=t.office;return t.personnel.map(t=>{const n=`${e[0]}\nPO Box 501370 CK\nSaipan MP, 96950`;let r,o;return t[0].split(", ").length>1?(r=t[0].split(", ").slice(0,-1).join(", "),o=t[0].split(", ").slice(-1)):(r=t[0],o=[""]),{title:r,status:"publish",fields:{address:n,name:r,telephone:t.slice(1,4).filter(t=>t.trim().length>0).join(", "),fax:t[4],email:t[5],job_title:o.join(",").trim()}}})}let S=(()=>{var t=i(function*(){const t=new class{constructor(t){this[d]=e.readFileSync("personnel.csv",{encoding:"utf-8"}),this[y]=t,this[g]=t.secure?"https://":"http://",this[m]=`${this[g]}${t.host}/wp-json/wp/v2/contact_info/`,this[v]=`${this[g]}${t.host}/wp-json/acf/v3/contact_info/`}parse(){var t=this;return i(function*(){const e=t[d],r=yield new Promise(function(t,r){n(e,{},function(e,n){e&&r(e),t(n)})});t[h]=yield r.reduce(w,[]).map(j).map(O).reduce(function(t,e){return[...t,...e]},[])})()}post(){var t=this;return i(function*(){t[P]=yield a(t[y]);const e=[];for(const n of t[h]){console.log(`Searching ${n.fields.email}`);const r=yield f.call(t,n);e.push(r)}for(const n of e)n instanceof Error?console.error(n.config.headers):n.title.trim().length>0&&(console.log(`Posting ${n.title}`),yield c.call(t,n))})()}}(b);yield t.parse(),yield t.post()});return function(){return t.apply(this,arguments)}})();const b=JSON.parse(e.readFileSync("contactUploader.json"));S()});
